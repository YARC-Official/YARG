name: Builds - MacOS (release)

on:
  workflow_dispatch:
  push:
    branches:
      - main

# concurrency:
#   group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
#   cancel-in-progress: true

jobs:
  macBuilder:
    name: ${{ matrix.targetPlatform }} on ${{ matrix.unityVersion }}
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        # projectPath:
        #   - test-project
        unityVersion:
          - 2021.3.21f1
        targetPlatform:
          - StandaloneOSX

    steps:
      ###########################
      #         Checkout        #
      ###########################
      - name: "[Pre-install] Pull project"
        uses: actions/checkout@v3
        with:
          lfs: true

      ###########################
      #          Cache          #
      ###########################
      - name: "[Pre-install] Restore 'library' cache"
        uses: actions/cache@v3
        with:
          path: Library
          key: YARG-Library-macos-${{ matrix.targetPlatform }}
          restore-keys: |
            YARG-Library-macos-
            YARG-Library-

      ###########################
      #     Install Blender     #
      ###########################
      # - name: "[Pre-install] Install Blender"
      #   run: brew install --cask blender

      - name: "[Pre-install] Install Blender (3.4.1)"
        run: >
          curl -L -o "blender.dmg" https://download.blender.org/release/Blender3.4/blender-3.4.1-macos-x64.dmg && 
          hdiutil attach ./blender.dmg && 
          cp -R /Volumes/Blender/Blender.app /Applications && 
          hdiutil unmount /Volumes/Blender &&
          rm -rf ./blender.dmg

      ###########################
      #    Install Libraries    #
      ###########################
      - name: "[Pre-install] Install Libraries"
        run: pip3 install requests && python3 InstallLibraries/install.py
        
      ###########################
      #    Restore  Packages    #
      ###########################
      - name: "[Pre-install] Restoring NuGet Packages"
        run: dotnet tool install --global NuGetForUnity.Cli && nugetforunity restore

      ###########################
      #          Build          #
      ###########################
      - name: "[Build] Run Builder"
        uses: game-ci/unity-builder@v2.2.0
        continue-on-error: true
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          # projectPath: ${{ matrix.projectPath }}
          buildName: YARG
          unityVersion: ${{ matrix.unityVersion }}
          targetPlatform: ${{ matrix.targetPlatform }}
          cacheUnityInstallationOnMac: true

      ###########################
      #        Compress         #
      ###########################
      - name: "[Post-build] Compress to a .zip"
        run: ditto -c -k --keepParent build/StandaloneOSX/YARG.app YARG-Release-OSX.zip

      ###########################
      #       Create .DMG       #
      ###########################
      # - name: "[Post-build] Create .dmg"
      #   continue-on-error: true
      #   run: >
      #     echo "- Installing create-dmg" &&
      #     brew install graphicsmagick imagemagick &&
      #     npm install --global create-dmg &&
      #     echo "- Creating DMG" &&
      #     create-dmg build/StandaloneOSX/YARG.app --dmg-title=YARG

      # - name: "[Post-build] Rename .dmg to YARG-Release-OSX.dmg"
      #   run: find . -name *.dmg -print -exec mv {} "YARG-Release-OSX.dmg" \;


      ###########################
      #          Upload         #
      ###########################
      - name: "[Post-build] Upload build to artifacts"
        uses: actions/upload-artifact@v3
        with:
          name: YARG-Release-OSX
          path: YARG-Release-OSX.dmg